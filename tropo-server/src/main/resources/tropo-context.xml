<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans" 
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:context="http://www.springframework.org/schema/context" 
    xmlns:lang="http://www.springframework.org/schema/lang"
    xmlns:p="http://www.springframework.org/schema/p" 
    xmlns:util="http://www.springframework.org/schema/util"
    xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
		http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.0.xsd
		http://www.springframework.org/schema/lang http://www.springframework.org/schema/lang/spring-lang-3.0.xsd
		http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-3.0.xsd"
    default-autowire="byName">

	<!-- Actor Thread Pool -->
	<bean id="executor" class="java.util.concurrent.Executors" factory-method="newCachedThreadPool" />
	
	<!-- Jetlang Fiber Factory -->
	<bean id="fiberFactory" class="org.jetlang.fibers.PoolFiberFactory">
		<constructor-arg ref="executor" />
	</bean>
	
	<!-- Global Call Registry -->
	<bean id="callRegistry" class="com.tropo.server.DefaultCallRegistry" />

	<!-- Call Statistics Service -->
	<bean id="callStatistics" class="com.tropo.server.CallStatistics"/>

	<!-- Ozone Statistics Service -->
	<bean id="ozoneStatistics" class="com.tropo.server.OzoneStatistics"/>

	<!-- Call Actor Factory -->
	<bean id="callActorFactory" class="com.tropo.server.DefaultCallActorFactory">
		<property name="fiberFactory" ref="fiberFactory" />
		<property name="verbManager" ref="verbManager" />
		<property name="callStatistics" ref="callStatistics" />
	</bean>	

	<!-- Call Manager: Responsible for maintaining the Call Registry and creating new CallActors -->
	<bean id="callManager" class="com.tropo.server.CallManager">
		<property name="callRegistry" ref="callRegistry" />
		<property name="callActorFactory" ref="callActorFactory" />
	</bean>

	<!-- Conference Manager -->	
	<bean id="conferenceController" class="com.tropo.server.conference.MohoConferenceController" />

	<!-- Model / Request Validation -->
	<bean id="validator" class="com.tropo.core.validation.Validator"/>

	<!-- Ozone providers -->
	<bean id="ozoneProvider" class="com.tropo.core.xml.providers.OzoneProvider">
		<property name="validator" ref="validator" />
		<property name="namespaces">
			<list>
				<value>urn:xmpp:ozone:1</value>
			</list>
		</property>		
	</bean>
	<bean id="sayProvider" class="com.tropo.core.xml.providers.SayProvider">
		<property name="validator" ref="validator" />
		<property name="namespaces">
			<list>
				<value>urn:xmpp:ozone:say:1</value>
			</list>
		</property>		
	</bean>
	<bean id="askProvider" class="com.tropo.core.xml.providers.AskProvider">
		<property name="validator" ref="validator" />
		<property name="namespaces">
			<list>
				<value>urn:xmpp:ozone:ask:1</value>
			</list>
		</property>		
	</bean>
	<bean id="transferProvider" class="com.tropo.core.xml.providers.TransferProvider">
		<property name="validator" ref="validator" />
		<property name="namespaces">
			<list>
				<value>urn:xmpp:ozone:transfer:1</value>
			</list>
		</property>		
	</bean>
	<bean id="conferenceProvider" class="com.tropo.core.xml.providers.ConferenceProvider">
		<property name="validator" ref="validator" />
		<property name="namespaces">
			<list>
				<value>urn:xmpp:ozone:conference:1</value>
			</list>
		</property>		
	</bean>				

	<!-- Create a global XML Provider -->
	<bean id="xmlProviderManager" class="com.tropo.core.xml.DefaultXmlProviderManagerFactoryBean">
		<property name="providers">
			<list>
				<ref bean="ozoneProvider"/>
				<ref bean="sayProvider"/>
				<ref bean="askProvider"/>
				<ref bean="transferProvider"/>
				<ref bean="conferenceProvider"/>
			</list>
		</property>		
	</bean>

	<!-- Verb Manager: Used to create VerbHandler instances and read/write XML -->
	<bean id="verbManager" class="com.tropo.server.verb.DefaultVerbManagerFactoryBean">
		<property name="verbManager">
			<bean class="com.tropo.server.verb.DefaultVerbManager">
				<property name="xmlProviderManager" ref="xmlProviderManager" />
			</bean>
		</property>
		<property name="verbFactoryList">
			<list>
				<!-- Say -->
				<bean class="com.tropo.server.verb.AbstractVerbFactory">
					<property name="xmlProvider" ref="sayProvider" />
					<property name="modelClass" value="com.tropo.core.verb.Say" />
					<lookup-method name="createVerbHandler" bean="sayHandler" />
				</bean>
				<!-- Ask -->
				<bean class="com.tropo.server.verb.AbstractVerbFactory">
					<property name="xmlProvider" ref="askProvider" />
					<property name="modelClass" value="com.tropo.core.verb.Ask" />
					<lookup-method name="createVerbHandler" bean="askHandler" />
				</bean>
				<!-- Transfer -->
				<bean class="com.tropo.server.verb.AbstractVerbFactory">
					<property name="xmlProvider" ref="transferProvider" />
					<property name="modelClass" value="com.tropo.core.verb.Transfer" />
					<lookup-method name="createVerbHandler" bean="transferHandler" />
				</bean>
				<!-- Conference -->
				<bean class="com.tropo.server.verb.AbstractVerbFactory">
					<property name="xmlProvider" ref="conferenceProvider" />
					<property name="modelClass" value="com.tropo.core.verb.Conference" />
					<lookup-method name="createVerbHandler" bean="conferenceHandler" />
				</bean>
			</list>
		</property>
	</bean>

	<!-- Verb Handlers -->	
	<bean id="sayHandler" class="com.tropo.server.verb.SayHandler" scope="prototype" />
	<bean id="askHandler" class="com.tropo.server.verb.AskHandler" scope="prototype" />
	<bean id="transferHandler" class="com.tropo.server.verb.TransferHandler" scope="prototype" />
	<bean id="conferenceHandler" class="com.tropo.server.verb.ConferenceHandler" scope="prototype">
		<property name="mohoConferenceController" ref="conferenceController" />
	</bean>

	<!-- Admin Service -->
	<bean id="adminService" class="com.tropo.server.AdminService"/>
	
	<!-- JMX Configuration -->
  	<bean id="exporter" class="org.springframework.jmx.export.MBeanExporter">
    	<property name="autodetect" value="true"/>
		<property name="namingStrategy" ref="namingStrategy"/>
    	<property name="assembler" ref="assembler"/>
  	</bean>

  	<bean id="callsBean" class="com.tropo.server.jmx.Calls">
  		<property name="callRegistry" ref="callRegistry" />
  		<property name="callStatistics" ref="callStatistics" />
  	</bean>

	<bean id="attributeSource" class="org.springframework.jmx.export.annotation.AnnotationJmxAttributeSource"/>
	
  	<bean id="assembler" class="org.springframework.jmx.export.assembler.MetadataMBeanInfoAssembler">
    	<property name="attributeSource" ref="attributeSource"/>
  	</bean> 
  	
	<bean id="namingStrategy" class="org.springframework.jmx.export.naming.MetadataNamingStrategy">
		<property name="attributeSource" ref="attributeSource"/>
	</bean>  	  
</beans>