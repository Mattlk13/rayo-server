<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans" 
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:context="http://www.springframework.org/schema/context" 
    xmlns:lang="http://www.springframework.org/schema/lang"
    xmlns:p="http://www.springframework.org/schema/p" 
    xmlns:util="http://www.springframework.org/schema/util"
    xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
		http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.0.xsd
		http://www.springframework.org/schema/lang http://www.springframework.org/schema/lang/spring-lang-3.0.xsd
		http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-3.0.xsd"
    default-autowire="byName">
	
	<util:list id="internalDomains" list-class="java.util.ArrayList">
		<value>internal.tropo.local</value>
	</util:list>

	<util:list id="externalDomains" list-class="java.util.ArrayList">
		<value>gw.tropo.local</value>
		<value>192.168.1.33</value>
		<value>localhost</value>
	</util:list>
	
	<!-- Exception Mapper -->
  	<bean id="exceptionMapper" class="com.rayo.server.exception.ExceptionMapper"/>
	
	<bean id="gateway" class="com.rayo.gateway.GatewayServlet" init-method="start">
		<property name="exceptionMapper" ref="exceptionMapper" />
		<property name="gatewayStatistics" ref="gatewayStatistics" />
		<property name="rayoLookupService">
		  	<!-- JID Redirection --> 
			<bean id="rayoJIDLookupService" class="com.rayo.server.lookup.RegexpJIDLookupService">
				<constructor-arg value="classpath:rayo-routing.properties"/>
			</bean>  		
		</property>
		<property name="internalDomains" ref="internalDomains"/>
		<property name="externalDomains" ref="externalDomains"/>
		<property name="gatewayDatastore" ref="gatewayStorageService"/>
	</bean>
	
	<!-- Admin Service -->
	<bean id="adminService" class="com.rayo.gateway.admin.GatewayAdminService"/>
	
	<!-- JMX Configuration -->
  	<bean id="exporter" class="org.springframework.jmx.export.MBeanExporter">
    	<property name="autodetect" value="true"/>
		<property name="namingStrategy" ref="namingStrategy"/>
    	<property name="assembler" ref="assembler"/>
  	</bean>
  	
  	<bean id="attributeSource" class="org.springframework.jmx.export.annotation.AnnotationJmxAttributeSource"/>
	
  	<bean id="assembler" class="org.springframework.jmx.export.assembler.MetadataMBeanInfoAssembler">
    	<property name="attributeSource" ref="attributeSource"/>
  	</bean> 
  	
	<bean id="namingStrategy" class="org.springframework.jmx.export.naming.MetadataNamingStrategy">
		<property name="attributeSource" ref="attributeSource"/>
	</bean>  	
  	
  	<bean id="infoBean" class="com.rayo.server.jmx.Info">
  		<property name="adminService" ref="adminService" />
  	</bean>
  	
  	<bean id="gatewayBean" class="com.rayo.gateway.jmx.Gateway">
  		<property name="gatewayDatastore" ref="gatewayStorageService" />
  		<property name="gatewayServlet" ref="gateway" />
  	</bean>
  	
  	<bean id="gatewayStatistics" class="com.rayo.gateway.jmx.GatewayStatistics">
  		<property name="gatewayDatastore" ref="gatewayStorageService" />
  	</bean>
  	
  	<!-- In-Memory based HashTables -->
	<bean id="inMemoryNodesStore" class="com.rayo.gateway.memory.InMemoryStore"/>
	<bean id="inMemoryCallsStore" class="com.rayo.gateway.memory.InMemoryStore"/>
	<bean id="inMemoryApplicationsStore" class="com.rayo.gateway.memory.InMemoryStore"/>
	
  	<!-- EHCache-based Distributed HashTables -->
  	<bean id="cacheManager" class="org.springframework.cache.ehcache.EhCacheManagerFactoryBean">
        <property name="configLocation"  value="/WEB-INF/ehcache.xml"/>        
    </bean>

	<bean id="abstractEhcacheStore" abstract="true" class="com.rayo.gateway.ehcache.AbstractEHCacheStore" init-method="init">
  		<property name="cacheManager" ref="cacheManager"/>
	</bean>

  	<bean id="ehcacheNodesStore" class="com.rayo.gateway.ehcache.EHCacheStore" parent="abstractEhcacheStore">
  		<property name="name" value="nodesCache"/>
  	</bean>
  	<bean id="ehcacheCallsStore" class="com.rayo.gateway.ehcache.EHCacheStore" parent="abstractEhcacheStore">
  		<property name="name" value="callsCache"/>
  	</bean>    
  	<bean id="ehcacheApplicationsStore" class="com.rayo.gateway.ehcache.EHCacheStore" parent="abstractEhcacheStore">
  		<property name="name" value="applicationsCache"/>
  	</bean>
  	
  	<!-- Gateway Storage Service -->
  	<bean id="gatewayStorageService" class="com.rayo.gateway.GatewayStorageService">
  		<property name="nodesDatastore" ref="nodesDatastore"/>
  		<property name="callsDatastore" ref="callsDatastore"/>
  		<property name="applicationsDatastore" ref="applicationsDatastore"/>
  	</bean>
  	
	<bean id="nodesDatastore" class="com.rayo.gateway.store.NodesDatastore">
		<property name="store" ref="inMemoryNodesStore"/>
	</bean>
	<bean id="callsDatastore" class="com.rayo.gateway.store.CallsDatastore">
		<property name="store" ref="inMemoryCallsStore"/>
	</bean>
	<bean id="applicationsDatastore" class="com.rayo.gateway.store.ApplicationsDatastore">
		<property name="store" ref="inMemoryApplicationsStore"/>
	</bean>
		
   	    
</beans>